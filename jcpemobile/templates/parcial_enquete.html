<div class="enquete">
  <h3>{{ enquete.titulo }}</h3>
  <p>{{ enquete.pergunta }}</p>

  <form class="enquete-form" data-id="{{ enquete.id }}">
    {% for opcao in enquete.opcoes.all %}
      <label>
        <input type="radio" name="opcao" value="{{ opcao.id }}">
        {{ opcao.texto }}
      </label><br>
    {% endfor %}
    <button type="submit">Votar</button>
  </form>

  <div id="resultado-{{ enquete.id }}"></div>
</div>

<script>
document.querySelectorAll('.enquete-form').forEach(form => {
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    const enqueteId = this.dataset.id;
    const formData = new FormData(this);

    const response = await fetch(`/enquetes/${enqueteId}/votar/`, {
      method: 'POST',
      headers: {'X-CSRFToken': '{{ csrf_token }}'},
      body: formData
    });

    const data = await response.json();
    const resultado = document.getElementById(`resultado-${enqueteId}`);

    if (data.erro) {
      resultado.innerHTML = `<p style="color:red;">${data.erro}</p>`;
    } else {
      let html = "<h4>Resultados:</h4>";
      data.resultados.forEach(r => {
        html += `<p>${r.texto}: ${r.percentual}%</p>`;
      });
      resultado.innerHTML = html;
    }
  });
});
</script>
